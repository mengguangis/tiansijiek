<html>

<head>
<title>Fragment Globe</title>
<meta charset ="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">  <!-- Use Chrome Frame in IE --> 
</head>

<body>
<div id="message" style="position:absolute;top:100px"></div> <!-- Pixel offset to avoid FPS counter -->
<canvas id="canvas" style="border: none;" width="1024" height="768" tabindex="1"></canvas>

<script id="pass_vs" type="x-shader/x-vertex">    
    precision highp float;

    uniform mat4 u_Model;
    uniform mat4 u_View;
    uniform mat4 u_Persp;
    uniform mat4 u_InvTrans;

    attribute vec3 Position;
    attribute vec3 Normal;
    attribute vec2 Texcoord;

    varying vec3 fs_Normal;
    varying vec4 fs_Position;

    void main(void) {
        fs_Normal = (u_InvTrans*vec4(Normal,0.0)).xyz;
        vec4 world = u_Model * vec4(Position, 1.0);
        vec4 camera = u_View * world;
        fs_Position = camera;
        gl_Position = u_Persp * camera;
    }
</script>

<script id="pass_fs" type="x-shader/x-fragment">
    #extension GL_EXT_draw_buffers : require
    precision highp float;

    uniform vec3 u_Color;

    //in
    varying vec3 fs_Normal;
    varying vec4 fs_Position;

    void main(void)
    {
        //normal, position, depth, color
        gl_FragData[0] = vec4(fs_Normal.xyz, 1.0);
        gl_FragData[1] = fs_Position;
        gl_FragData[2] = vec4(u_Color, 1.0);
        //vec4(0.0, 0.0, 1.0, 1.0);
        //gl_FragData[3] = vec4(0.0, 0.0, 0.0, 1.0);

        //gl_FragColor = vec4(vec3(0.2), 1.0);
    }
</script>


<script id="shade_vs" type="x-shader/x-vertex">
    precision highp float;

    attribute vec3 Position;
    attribute vec2 Texcoord;

    varying vec2 fs_Texcoord;

    void main() {
        fs_Texcoord = Texcoord * 0.5 + vec2(0.5);
        gl_Position = vec4(Position,1.0);
    }
</script>

<script id="diagnostic_fs" type="x-shader/x-fragment">
    #extension GL_EXT_draw_buffers : require
    precision highp float;

    #define DISPLAY_DEPTH 0
    #define DISPLAY_NORMAL 1
    #define DISPLAY_POSITION 2
    #define DISPLAY_COLOR 3
    #define DISPLAY_TOTAL 4
    #define DISPLAY_LIGHTS 5

    uniform sampler2D u_Depthtex;
    uniform sampler2D u_Normaltex;
    uniform sampler2D u_Positiontex;
    uniform sampler2D u_Colortex;

    uniform int u_DisplayType;
    uniform float u_Far;
    uniform float u_Near;

    uniform vec4 u_Light;

    varying vec2 fs_Texcoord;

    float linearizeDepth(float exp_depth, float near, float far) {
        return  (2.0 * near) / (far + near -  exp_depth * (far - near)); 
    }   
    
    void main(void)
    {
        vec3 depth = texture2D(u_Depthtex, fs_Texcoord).xyz;

        float exp_depth = texture2D(u_Depthtex, fs_Texcoord).r;
        float lin_depth = linearizeDepth(exp_depth,u_Near,u_Far);

        vec3 normal = texture2D(u_Normaltex, fs_Texcoord).xyz;
        vec3 position = texture2D(u_Positiontex, fs_Texcoord).xyz;
        vec3 color = texture2D(u_Colortex, fs_Texcoord).xyz;

        vec3 light = u_Light.xyz;
        float diffuse = max(dot(normal, normalize(light - position)),0.0);

        if(u_DisplayType == DISPLAY_DEPTH)
            gl_FragData[0] = vec4(vec3(lin_depth), 1.0);
        else if(u_DisplayType == DISPLAY_NORMAL)
            gl_FragData[0] = vec4(abs(normal), 1.0);
        else if(u_DisplayType == DISPLAY_POSITION)
            gl_FragData[0] = vec4(abs(position)/u_Far, 1.0);
        else if(u_DisplayType == DISPLAY_COLOR)
            gl_FragData[0] = vec4(color, 1.0);
        else
            gl_FragData[0] = vec4(diffuse * color, 1.0);
       // else
        //    gl_FragColor[0] = vec4(0.0);
        //gl_FragColor = vec4(no, 1.0);
        //gl_FragColor = vec4(vec3(0.7), 1.0);

    }
</script>


<script id="ambient_fs" type="x-shader/x-fragment">
    #extension GL_EXT_draw_buffers : require
    precision highp float;

    uniform sampler2D u_Depthtex;
    uniform sampler2D u_Normaltex;
    uniform sampler2D u_Positiontex;
    uniform sampler2D u_Colortex;

    uniform int u_DisplayType;

    varying vec2 fs_Texcoord;
    void main(void)
    {     
        vec3 depth = texture2D(u_Depthtex, fs_Texcoord).xyz;
        vec3 normal = texture2D(u_Normaltex, fs_Texcoord).xyz;
        vec3 position = texture2D(u_Positiontex, fs_Texcoord).xyz;
        vec3 color = texture2D(u_Colortex, fs_Texcoord).xyz;

        gl_FragData[0] = vec4(vec3(0.0), 1.0);
    }
</script>


<script id="post_vs" type="x-shader/x-vertex">
    precision highp float;

    attribute vec3 Position;
    attribute vec2 Texcoord;

    varying vec2 fs_Texcoord;

    void main() {
        fs_Texcoord = Texcoord * 0.5 + vec2(0.5);
        gl_Position = vec4(Position,1.0);
    }

</script>


<script id="post_fs" type="x-shader/x-fragment">    
    precision highp float;
    uniform sampler2D u_Posttex;

    varying vec2 fs_Texcoord;
    varying vec4 out_Color;

    void main(void)
    {       
        vec3 out_Color = texture2D(u_Posttex, fs_Texcoord).xyz;
        gl_FragColor = vec4(out_Color, 1.0);
    }

</script>

<script src ="Stats.js" type ="text/javascript"></script>
<script src ="gl-matrix.js" type ="text/javascript"></script>
<script src ="webGLUtility.js" type ="text/javascript"></script>
<script src ="deferred.js" type ="text/javascript"></script>

</body>

</html>
